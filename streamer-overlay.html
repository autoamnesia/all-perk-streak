<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DBD Perk Streak - Streamer Overlay</title>
  <link rel="stylesheet" href="streamer-overlay.css">
  <style>
    #secret-image {
      display: none;
      position: absolute;
      top: 0; left: 0; right: 0; margin: auto;
      max-width: 100%; max-height: 100%;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
    }
    #killer-card { position: relative; }
  </style>
</head>
<body>
  <div class="overlay-card" id="killer-card">
    <div class="overlay-title">All Perk Streak</div>
    <div class="progress-section">
      <div class="progress-bar-bg">
        <div class="progress-bar-fill killer-fill" id="killer-bar" style="width: 0%"></div>
      </div>
      <div class="progress-count" id="killer-count">0/0</div>
    </div>
    <img id="secret-image" src="assets/characters/a.jpg" alt="Secret" />
  </div>
  <div class="overlay-card" id="survivor-card" style="margin-top:16px;">
    <div class="overlay-title">All Perk Streak</div>
    <div class="progress-section">
      <div class="progress-bar-bg">
        <div class="progress-bar-fill survivor-fill" id="survivor-bar" style="width: 0%"></div>
      </div>
      <div class="progress-count" id="survivor-count">0/0</div>
    </div>
  </div>

  <script>
    // Show both killer and survivor progress at once
    async function updateBoth() {
      try {
        const response = await fetch('/api/progress');
        if (!response.ok) throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        const progressData = await response.json();
        // Killer
        document.getElementById('killer-count').textContent = progressData.killerCompleted + '/' + progressData.killerTotal;
        const killerPercent = progressData.killerTotal > 0 ? (progressData.killerCompleted / progressData.killerTotal) * 100 : 0;
        document.getElementById('killer-bar').style.width = killerPercent + '%';
        // Survivor
        document.getElementById('survivor-count').textContent = progressData.survivorCompleted + '/' + progressData.survivorTotal;
        const survivorPercent = progressData.survivorTotal > 0 ? (progressData.survivorCompleted / progressData.survivorTotal) * 100 : 0;
        document.getElementById('survivor-bar').style.width = survivorPercent + '%';
      } catch (error) {
        document.getElementById('killer-count').textContent = 'Error';
        document.getElementById('killer-bar').style.width = '0%';
        document.getElementById('survivor-count').textContent = 'Error';
        document.getElementById('survivor-bar').style.width = '0%';
      }
    }
    updateBoth();
    setInterval(updateBoth, 2000);

    // --- Secret image logic (OBS-safe) ---
    function showSecretImage() {
      const img = document.getElementById('secret-image');
      img.style.display = 'block';
      setTimeout(() => { img.style.opacity = '1'; }, 10); // Fade in
      setTimeout(() => {
        img.style.opacity = '0'; // Fade out
        setTimeout(() => { img.style.display = 'none'; }, 500);
      }, 5000); // Show for 5 seconds

      // Next appearance in 1 hour
      const nextTime = Date.now() + (60 * 60 * 1000);
      localStorage.setItem('nextSecretImageTime', nextTime.toString());
      console.log('ðŸ•‘ Secret image shown, next in 1 hour at', new Date(nextTime).toLocaleTimeString());
    }

    function checkSecretImage() {
      const savedNextTime = localStorage.getItem('nextSecretImageTime');
      const now = Date.now();

      if (!savedNextTime) {
        // First ever load â†’ schedule 1 hour from now
        const nextTime = now + (60 * 60 * 1000);
        localStorage.setItem('nextSecretImageTime', nextTime.toString());
        console.log('ðŸ•‘ First load: secret image scheduled 1 hour from now at', new Date(nextTime).toLocaleTimeString());
        return;
      }

      const nextTime = parseInt(savedNextTime, 10);

      if (now >= nextTime) {
        // Expired while overlay was closed â†’ schedule 10 min from now
        const newNextTime = now + (10 * 60 * 1000);
        localStorage.setItem('nextSecretImageTime', newNextTime.toString());
        console.log('ðŸ•‘ Timer expired while closed, rescheduled 10 min from now at', new Date(newNextTime).toLocaleTimeString());
        return;
      }

      // If close to scheduled time (within 15s), show the image
      if (now < nextTime && nextTime - now <= 15000) {
        showSecretImage();
      }
    }

    // Check every 15 seconds
    setInterval(checkSecretImage, 15000);
    // Run once immediately
    checkSecretImage();
  </script>
</body>
</html>
