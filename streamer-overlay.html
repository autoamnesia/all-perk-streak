<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DBD Perk Streak - Streamer Overlay</title>
  <link rel="stylesheet" href="streamer-overlay.css">
  <style>
    #secret-image {
      display: none;
      position: absolute;
      top: 0; left: 0; right: 0; margin: auto;
      max-width: 100%; max-height: 100%;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
    }
    #killer-card { position: relative; }
  </style>
</head>
<body>
  <div class="overlay-card" id="killer-card">
    <div class="overlay-title">All Perk Streak</div>
    <div class="progress-section">
      <div class="progress-bar-bg">
        <div class="progress-bar-fill killer-fill" id="killer-bar" style="width: 0%"></div>
      </div>
      <div class="progress-count" id="killer-count">0/0</div>
    </div>
    <img id="secret-image" src="assets/characters/a.jpg" alt="Secret" />
  </div>
  <div class="overlay-card" id="survivor-card" style="margin-top:16px;">
    <div class="overlay-title">All Perk Streak</div>
    <div class="progress-section">
      <div class="progress-bar-bg">
        <div class="progress-bar-fill survivor-fill" id="survivor-bar" style="width: 0%"></div>
      </div>
      <div class="progress-count" id="survivor-count">0/0</div>
    </div>
  </div>

  <script>
    // Show both killer and survivor progress at once
    async function updateBoth() {
      try {
        const response = await fetch('/api/progress');
        if (!response.ok) throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        const progressData = await response.json();
        // Killer
        document.getElementById('killer-count').textContent = progressData.killerCompleted + '/' + progressData.killerTotal;
        const killerPercent = progressData.killerTotal > 0 ? (progressData.killerCompleted / progressData.killerTotal) * 100 : 0;
        document.getElementById('killer-bar').style.width = killerPercent + '%';
        // Survivor
        document.getElementById('survivor-count').textContent = progressData.survivorCompleted + '/' + progressData.survivorTotal;
        const survivorPercent = progressData.survivorTotal > 0 ? (progressData.survivorCompleted / progressData.survivorTotal) * 100 : 0;
        document.getElementById('survivor-bar').style.width = survivorPercent + '%';
      } catch (error) {
        document.getElementById('killer-count').textContent = 'Error';
        document.getElementById('killer-bar').style.width = '0%';
        document.getElementById('survivor-count').textContent = 'Error';
        document.getElementById('survivor-bar').style.width = '0%';
      }
    }
    updateBoth();
    setInterval(updateBoth, 2000);

    // Secret image logic
    function showSecretImage() {
      const img = document.getElementById('secret-image');
      img.style.display = 'block';
      setTimeout(() => { img.style.opacity = '1'; }, 10); // Fade in
      setTimeout(() => {
        img.style.opacity = '0'; // Fade out
        setTimeout(() => { img.style.display = 'none'; }, 500);
      }, 5000); // Show for 5 seconds
      
      // Schedule next appearance
      scheduleNextImage();
    }

    function scheduleNextImage() {
      const nextTime = Date.now() + (60 * 60 * 1000); // 1 hour from now
      localStorage.setItem('nextSecretImageTime', nextTime.toString());
    }

    function initializeSecretImage() {
      const savedNextTime = localStorage.getItem('nextSecretImageTime');
      let timeUntilNext;
      
      if (savedNextTime) {
        const nextTime = parseInt(savedNextTime);
        timeUntilNext = nextTime - Date.now();
        
        // If the scheduled time has passed, schedule for 10 minutes from now
        if (timeUntilNext <= 0) {
          timeUntilNext = 10 * 60 * 1000; // 10 minutes
          const newNextTime = Date.now() + timeUntilNext;
          localStorage.setItem('nextSecretImageTime', newNextTime.toString());
        }
      } else {
        // First time setup - schedule for 1 hour from now
        timeUntilNext = 60 * 60 * 1000; // 1 hour
        scheduleNextImage();
      }
      
      // Set timeout for the next appearance
      setTimeout(showSecretImage, timeUntilNext);
    }

    // Initialize the secret image timer
    initializeSecretImage();
  </script>
</body>
</html>